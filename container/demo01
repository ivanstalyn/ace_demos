ARG ACE_VERSION
ARG ACE_IMAGE_BASE

FROM ${ACE_IMAGE_BASE}:${ACE_VERSION}

USER 0

COPY ace_demo_01/ proyectos/ace_demo_01/
COPY ace_demo_dfdl/ proyectos/ace_demo_dfdl/
COPY container/demo01.properties proyectos/overrides/
COPY container/shell/*.sh /usr/local/bin/
RUN chmod +rx /usr/local/bin/*.sh && \
    . /opt/ibm/ace-12/server/bin/mqsiprofile && \
    ibmint package --compile-maps-and-schemas --input-path proyectos --output-bar-file /tmp/temp.bar  2>&1 | tee -a /tmp/deploys && \
    ibmint apply overrides proyectos/overrides/* --bar-file /tmp/temp.bar 2>&1 | tee -a /tmp/deploys && \
    ibmint deploy --input-bar-file /tmp/temp.bar --output-work-directory /home/aceuser/ace-server/ 2>&1 | tee -a /tmp/deploys && \
    ibmint optimize server --work-directory /home/aceuser/ace-server && \
    chown aceuser:aceuser -R /home/aceuser
    
USER aceuser

EXPOSE 7600 7800 7843

RUN echo ". /opt/ibm/ace-12/server/bin/mqsiprofile" >> /home/aceuser/.bashrc 

ENTRYPOINT ["ace_manage.sh"]
